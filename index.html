

<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Analytics Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #4361ee;
      --primary-light: #eef2ff;
      --secondary: #3f37c9;
      --success: #4cc9f0;
      --danger: #f72585;
      --warning: #f8961e;
      --dark: #1a1b41;
      --light: #f8f9fa;
      --gray: #6c757d;
      --gray-light: #adb5bd;
      --border-radius: 12px;
      --shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
      --shadow-hover: 0 15px 40px rgba(0, 0, 0, 0.12);
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #f5f7ff 0%, #f0f4ff 100%);
      color: var(--dark);
      min-height: 100vh;
      padding-bottom: 40px;
    }

    header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      padding: 25px 0;
      box-shadow: 0 4px 20px rgba(67, 97, 238, 0.2);
      position: relative;
      overflow: hidden;
    }

    header::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 100%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
      background-size: 30px 30px;
      opacity: 0.3;
    }

    .wrap {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
      position: relative;
      z-index: 1;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo i {
      font-size: 28px;
      background: rgba(255,255,255,0.2);
      padding: 12px;
      border-radius: 10px;
    }

    .logo h1 {
      font-size: 24px;
      font-weight: 700;
    }

    .logo span {
      font-weight: 400;
      opacity: 0.9;
      font-size: 14px;
      margin-left: 5px;
    }

    .header-info {
      text-align: right;
    }

    .header-info small {
      opacity: 0.8;
      font-size: 13px;
      display: block;
      margin-top: 5px;
    }

    main {
      margin-top: 30px;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 20px;
    }

    .controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .btn {
      margin-top: 20px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(67, 97, 238, 0.2);
    }

    .btn:hover {
      background: var(--secondary);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(67, 97, 238, 0.3);
    }

    .btn i {
      font-size: 14px;
    }

    .last-updated {
      background: white;
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .last-updated i {
      color: var(--primary);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      border-left: 4px solid var(--primary);
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-hover);
    }

    .stat-card:nth-child(2) { border-left-color: var(--success); }
    .stat-card:nth-child(3) { border-left-color: var(--warning); }
    .stat-card:nth-child(4) { border-left-color: var(--danger); }

    .stat-icon {
      width: 50px;
      height: 50px;
      background: var(--primary-light);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
    }

    .stat-card:nth-child(2) .stat-icon { background: rgba(76, 201, 240, 0.1); }
    .stat-card:nth-child(3) .stat-icon { background: rgba(248, 150, 30, 0.1); }
    .stat-card:nth-child(4) .stat-icon { background: rgba(247, 37, 133, 0.1); }

    .stat-icon i {
      font-size: 24px;
      color: var(--primary);
    }

    .stat-card:nth-child(2) .stat-icon i { color: var(--success); }
    .stat-card:nth-child(3) .stat-icon i { color: var(--warning); }
    .stat-card:nth-child(4) .stat-icon i { color: var(--danger); }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      margin: 10px 0 5px;
      color: var(--dark);
    }

    .stat-label {
      font-size: 14px;
      color: var(--gray);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 25px;
    }

    @media (max-width: 1100px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: white;
      border-radius: var(--border-radius);
      padding: 25px;
      box-shadow: var(--shadow);
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }

    .panel-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .panel-title i {
      color: var(--primary);
    }

    .page-views-container {
      margin-top: 10px;
    }

    .page-view-item {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
      padding: 10px;
      border-radius: 8px;
      transition: var(--transition);
    }

    .page-view-item:hover {
      background: var(--primary-light);
    }

    .page-label {
      flex: 1;
      font-weight: 500;
      color: var(--dark);
      font-size: 14px;
    }

    .page-value {
      font-weight: 600;
      color: var(--dark);
      min-width: 40px;
      text-align: right;
    }

    .progress-container {
      flex: 2;
      height: 10px;
      background: #e9ecef;
      border-radius: 5px;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      border-radius: 5px;
      min-width: 3%;
      transition: width 1s ease;
    }

    .country-item {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
      padding: 10px;
      border-radius: 8px;
      transition: var(--transition);
    }

    .country-item:hover {
      background: var(--primary-light);
    }

    .country-flag {
      width: 30px;
      height: 20px;
      border-radius: 3px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      flex-shrink: 0;
    }

    .country-name {
      flex: 1;
      font-weight: 500;
      color: var(--dark);
      font-size: 14px;
    }

    .table-container {
      overflow-x: auto;
      border-radius: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: linear-gradient(to right, var(--primary), var(--secondary));
    }

    th {
      padding: 16px 15px;
      text-align: left;
      font-weight: 600;
      color: white;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    tbody tr {
      border-bottom: 1px solid #f0f0f0;
      transition: var(--transition);
    }

    tbody tr:hover {
      background: var(--primary-light);
    }

    td {
      padding: 14px 15px;
      font-size: 14px;
      color: var(--dark);
    }

    .session-id {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: var(--gray);
    }

    .event-type {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      display: inline-block;
    }

    .event-type.pageview {
      background: rgba(67, 97, 238, 0.1);
      color: var(--primary);
    }

    .event-type.other {
      background: rgba(108, 117, 125, 0.1);
      color: var(--gray);
    }

    .loading {
      opacity: 0.7;
      pointer-events: none;
    }

    .loading::after {
      content: '';
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--gray);
    }

    .empty-state i {
      font-size: 48px;
      margin-bottom: 15px;
      opacity: 0.3;
    }

    .error-state {
      background: rgba(247, 37, 133, 0.1);
      border: 1px solid var(--danger);
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      text-align: center;
    }

    .error-state i {
      color: var(--danger);
      font-size: 24px;
      margin-bottom: 10px;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .stat-card, .panel {
      animation: fadeIn 0.5s ease forwards;
    }


    /* Shrink left panel width */
.dashboard-grid > div:first-child {
  max-width: 700px; /* adjust as needed */
}

/* Make page view items thinner */
.page-views-container div {
  margin-bottom: 8px; /* reduce spacing */
  font-size: 13px;
}

/* Progress bars thinner */
.page-views-container .progress-bar {
  height: 6px; /* thinner line */
  border-radius: 3px;
}

/* Country bars thinner */
#countryContainer div {
  margin-bottom: 8px; /* reduce spacing */
  font-size: 13px;
}

#countryContainer div span, #countryContainer div strong {
  font-size: 13px;
}

/* Make table scrollable if needed */
.table-container {
  max-height: 400px; /* optional: limits table height */
  overflow-y: auto;
}

/* Adjust padding in page/country items */
.page-view-item, .country-item {
  padding: 6px 8px;
}



/* Adjust dashboard grid */
.dashboard-grid {
  display: grid;
  grid-template-columns: 1fr 550px; /* left panel auto, right panel wider */
  gap: 25px;
}
/* ======================== MOBILE RESPONSIVE ======================== */

/* Make wrap fluid */
@media (max-width: 1200px) {
  .wrap {
    width: 95%;
    padding: 0 15px;
  }
}

/* Dashboard header controls stacking on small screens */
@media (max-width: 900px) {
  .dashboard-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 15px;
  }
}

/* Stats grid adjustments */
@media (max-width: 800px) {
  .stats-grid {
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 15px;
  }

  .stat-card {
    padding: 18px;
  }

  .stat-value {
    font-size: 26px;
  }

  .stat-label {
    font-size: 12px;
  }

  .stat-icon {
    width: 45px;
    height: 45px;
  }

  .stat-icon i {
    font-size: 20px;
  }
}

/* Dashboard grid stacking */
@media (max-width: 1100px) {
  .dashboard-grid {
    grid-template-columns: 1fr;
    gap: 20px;
  }
}

/* Panel padding and fonts on small screens */
@media (max-width: 700px) {
  .panel {
    padding: 15px;
  }

  .panel-title {
    font-size: 16px;
  }

  .panel-header .small {
    font-size: 11px;
  }

  .page-view-item, .country-item {
    flex-direction: column;
    align-items: flex-start;
    gap: 5px;
    padding: 6px 8px;
    font-size: 12px;
  }

  .page-label, .country-name {
    font-size: 13px;
  }

  .page-value {
    font-size: 12px;
  }

  .progress-container {
    height: 6px;
  }

  .progress-bar {
    font-size: 9px;
    padding: 0 3px;
  }
}

/* Table adjustments for very small screens */
@media (max-width: 600px) {
  table th, table td {
    padding: 8px 10px;
    font-size: 12px;
  }

  .session-id {
    font-size: 11px;
  }

  .event-type {
    font-size: 11px;
    padding: 3px 6px;
  }
}

/* Header adjustments */
@media (max-width: 500px) {
  header .header-content {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }

  .logo h1 {
    font-size: 20px;
  }

  .logo span {
    font-size: 12px;
  }

  .header-info {
    text-align: left;
    font-size: 12px;
  }

  .btn {
    font-size: 12px;
    padding: 8px 12px;
  }

  .last-updated {
    font-size: 12px;
    padding: 6px 10px;
  }
}
/* ==================== MOBILE OPTIMIZATION: TABLE & CARDS ==================== */

/* Table container fully responsive */
@media (max-width: 700px) {
  .table-container {
    width: 100%;
    overflow-x: hidden;  /* removes horizontal scroll */
  }

  table {
    font-size: 12px;
  }

  th, td {
    padding: 5px 8px;
  }

  .session-id {
    font-size: 10px;
  }

  .event-type {
    font-size: 10px;
    padding: 2px 6px;
  }
}

/* Stat cards: center & smaller on mobile */
@media (max-width: 800px) {
  .stats-grid {
    display: flex;
    flex-wrap: wrap;
    justify-content: center; /* center the cards */
    gap: 12px;
  }

  .stat-card {
    flex: 0 1 160px; /* card width smaller */
    padding: 15px;
    text-align: center; /* center content inside cards */
  }

  .stat-icon {
    width: 40px;
    height: 40px;
    margin: 0 auto 10px auto;
  }

  .stat-icon i {
    font-size: 18px;
  }

  .stat-value {
    font-size: 24px;
  }

  .stat-label {
    font-size: 12px;
  }
}

/* Panels inner content tighter */
@media (max-width: 700px) {
  .panel {
    padding: 15px;
  }

  .panel-title {
    font-size: 15px;
  }

  .panel-header .small {
    font-size: 11px;
  }

  .page-view-item, .country-item {
    font-size: 12px;
  }

  .page-value, .country-name {
    font-size: 12px;
  }

  .progress-bar {
    font-size: 9px;
    padding: 0 3px;
  }
}
/* ==================== MOBILE RESPONSIVE PANELS ==================== */

/* Dashboard grid: stack panels on small screens */
@media (max-width: 900px) {
  .dashboard-grid {
    display: flex;
    flex-direction: column;
    gap: 20px; /* spacing between panels */
  }

  /* Each panel takes full width */
  .dashboard-grid > div {
    width: 100%;
  }

  .panel {
    padding: 15px; /* smaller padding for mobile */
  }

  .panel-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 5px;
  }

  .panel-title {
    font-size: 16px;
  }

  .panel-header .small {
    font-size: 12px;
  }

  .page-views-container, #countryContainer {
    max-width: 100%;
  }

  .page-view-item, .country-item {
    flex-direction: column;
    align-items: flex-start;
    gap: 5px;
  }

  .progress-container {
    width: 100%;
  }

  .progress-bar {
    font-size: 10px;
    padding: 0 4px;
  }

  .page-label, .country-name {
    font-size: 13px;
  }

  .page-value {
    font-size: 12px;
    font-weight: 600;
  }

  .country-flag {
    width: 28px;
    height: 18px;
  }
}

/* Table: fit inside mobile screen */
@media (max-width: 700px) {
  .table-container {
    width: 100%;
    overflow-x: hidden; /* remove horizontal scroll */
  }

  table {
    font-size: 12px;
  }

  th, td {
    padding: 6px 8px;
  }

  .session-id {
    font-size: 10px;
  }

  .event-type {
    font-size: 10px;
    padding: 2px 6px;
  }
}

/* Stat cards: center & smaller on mobile */
@media (max-width: 800px) {
  .stats-grid {
    display: flex;
    flex-wrap: wrap;
    justify-content: center; /* center the cards */
    gap: 12px;
  }

  .stat-card {
    flex: 0 1 150px; /* smaller width */
    padding: 12px;
    text-align: center; /* center content inside cards */
  }

  .stat-icon {
    width: 38px;
    height: 38px;
    margin: 0 auto 10px auto;
  }

  .stat-icon i {
    font-size: 18px;
  }

  .stat-value {
    font-size: 22px;
  }

  .stat-label {
    font-size: 12px;
  }
}
/* -------------------- MOBILE SPECIFIC FIXES -------------------- */
@media (max-width: 700px) {
  /* Hide live tracking info in header */
  .header-info {
    display: none;
  }

  /* Reduce progress bar numbers font size */
  .page-view-item .progress-bar,
  .country-item .progress-bar {
    font-size: 8px; /* chhota font mobile ke liye */
    padding: 2px 4px;
  }

  /* Optional: hide number completely under progress bar */
   
  .page-view-item .progress-bar,
  .country-item .progress-bar {
    font-size: 0;
  } 
  
}

@media (max-width: 700px) {
  /* Mobile par progress bar numbers chhote karna */
  .page-view-item .progress-bar,
  .country-item .progress-bar {
    font-size: 12px; /* aap 14 ya 16 ke hisaab se adjust kar sakti ho */
    padding: 3px 5px; /* thoda padding reduce */
  }
}

/* Make Recent Activity table fully responsive on mobile */
@media (max-width: 700px) {
  .table-container {
    width: 100%;
    overflow-x: auto; /* allow horizontal scroll if needed */
    -webkit-overflow-scrolling: touch; /* smooth scrolling on iOS */
  }

  table {
    width: 100%;
    min-width: 500px; /* prevent too narrow table */
    font-size: 12px;
    border-collapse: collapse;
  }

  th, td {
    padding: 6px 8px;
    text-align: left;
    white-space: nowrap; /* keep content in single line */
  }

  .session-id, .event-type {
    font-size: 11px;
  }

  /* Optional: make small text fit */
  .empty-state div {
    font-size: 12px;
  }
}

  </style>
</head>
<body>

<header>
  <div class="wrap">
    <div class="header-content">
      <div class="logo">
        <i class="fas fa-chart-line"></i>
        <div>
          <h1>VIC Green Dashboard </h1>
          <small>Real-time website performance metrics</small>
        </div>
      </div>
      <div class="header-info">
        <div>Live Tracking Active</div>
        <small>Data source: /events endpoint</small>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="dashboard-header">
    <div class="controls">
      <button id="reloadBtn" class="btn">
        <i class="fas fa-sync-alt"></i> Refresh Data
      </button>
      <button id="exportBtn" class="btn" style="background: var(--success);">
        <i class="fas fa-download"></i> Export
      </button>
    </div>
    <div class="last-updated">
      <i class="fas fa-clock"></i>
      <span id="lastUpdated">Last updated: Just now</span>
    </div>
  </div>

  <div id="errorContainer" style="display: none;"></div>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon">
        <i class="fas fa-broadcast-tower"></i>
      </div>
      <div class="stat-value" id="totalEvents">0</div>
      <div class="stat-label">Total Events</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">
        <i class="fas fa-users"></i>
      </div>
      <div class="stat-value" id="uniqueSessions">0</div>
      <div class="stat-label">Unique Sessions</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">
        <i class="fas fa-stopwatch"></i>
      </div>
      <div class="stat-value" id="avgTime">0</div>
      <div class="stat-label">Avg Time (seconds)</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">
        <i class="fas fa-eye"></i>
      </div>
      <div class="stat-value" id="pageviews">0</div>
      <div class="stat-label">Page Views</div>
    </div>
  </div>

  <div class="dashboard-grid">
    <div>
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">
            <i class="fas fa-file-alt"></i> Page Views Distribution
          </div>
          <div class="small">Top performing pages</div>
        </div>
        <div id="pageViewsContainer" class="page-views-container">
          <div class="empty-state">
            <i class="fas fa-chart-bar"></i>
            <div>No page view data available</div>
          </div>
        </div>
      </div>

      <div class="panel" style="margin-top: 25px;">
        <div class="panel-header">
          <div class="panel-title">
            <i class="fas fa-globe-americas"></i> Country Distribution
          </div>
          <div class="small">Global user locations</div>
        </div>
        <div id="countryContainer">
          <div class="empty-state">
            <i class="fas fa-globe"></i>
            <div>No country data available</div>
          </div>
        </div>
      </div>
    </div>

    <div>
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">
            <i class="fas fa-history"></i> Recent Activity
          </div>
          <div class="small">Latest 15 events</div>
        </div>
        <div class="table-container">
          <table id="eventsTable">
            <thead>
              <tr>
                <th>Session</th>
                <th>Type</th>
                <th>Page</th>
                <th>Country</th>
                <th>Time</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="5" class="empty-state">
                  <i class="fas fa-inbox"></i>
                  <div>No events recorded yet</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
let startTime = Date.now();
let sessionId = localStorage.getItem('sessionId') || 'user_' + Math.floor(Math.random() * 1000000);
localStorage.setItem('sessionId', sessionId);

const colors = ['#4361ee', '#3f37c9', '#4cc9f0', '#4895ef', '#560bad', '#7209b7', '#b5179e', '#f72585', '#4a4e69', '#9a8c98', '#c9ada7', '#f2e9e4'];
const allPages = ["Home", "About", "Contact Us", "Air Conditioner", "Heat pump", "Residential", "Commercial", "Solar Batteries", "Weather Seal", "Energy Advisor", "Shower Head"];
const countryFlags = {'US': 'üá∫üá∏', 'UK': 'üá¨üáß', 'CA': 'üá®üá¶', 'AU': 'üá¶üá∫', 'DE': 'üá©üá™', 'FR': 'üá´üá∑', 'JP': 'üáØüáµ', 'IN': 'üáÆüá≥', 'BR': 'üáßüá∑', 'Unknown': 'üè≥Ô∏è'};

// Debug function to show errors
function showError(message) {
  const errorContainer = document.getElementById('errorContainer');
  errorContainer.innerHTML = `
    <div class="error-state">
      <i class="fas fa-exclamation-triangle"></i>
      <h3>Error Loading Data</h3>
      <p>${message}</p>
      <p><small>Make sure the backend server is running on http://localhost:3000</small></p>
    </div>
  `;
  errorContainer.style.display = 'block';
}

// Hide error
function hideError() {
  document.getElementById('errorContainer').style.display = 'none';
}

// Send pageview on unload
window.addEventListener('beforeunload', () => {
  const duration = Math.round((Date.now() - startTime) / 1000);
  try {
    navigator.sendBeacon('https://backend-vic-7e5x.vercel.app/track', JSON.stringify({
      sessionId,
      type: 'pageview',
      pagePath: document.title || 'Home',
      country: 'Unknown',
      timeOnPageSec: duration
    }));
  } catch (e) {
    console.warn('Could not send beacon:', e);
  }
});

// Load events with better error handling
async function loadEvents() {
  const reloadBtn = document.getElementById('reloadBtn');
  const lastUpdated = document.getElementById('lastUpdated');
  
  reloadBtn.classList.add('loading');
  lastUpdated.innerHTML = '<i class="fas fa-spinner"></i> Loading...';
  
  try {
    console.log('Fetching events from https://backend-vic-7e5x.vercel.app/events');
    const response = await fetch('https://backend-vic-7e5x.vercel.app/events', {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      },
      mode: 'cors' // Try to fetch with CORS
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    console.log('Events loaded:', data);
    hideError();
    return Array.isArray(data) ? data : [];
    
  } catch (error) {
    console.error('Failed to load events:', error);
    showError(`Failed to connect to backend: ${error.message}`);
    return [];
  } finally {
    reloadBtn.classList.remove('loading');
  }
}

// Summarize events
function summarize(events) {
  const pages = {}, countries = {}, sessions = new Map();
  let totalTime = 0, pageviews = 0;

  events.forEach(ev => {
    if (ev.type === 'pageview') pageviews++;
    
    const page = ev.pagePath || 'Home';
    pages[page] = (pages[page] || 0) + 1;

    const country = ev.country || 'Unknown';
    countries[country] = (countries[country] || 0) + 1;

    const sid = ev.sessionId || ('s_' + Math.random());
    if (!sessions.has(sid)) sessions.set(sid, { time: 0, count: 0 });
    sessions.get(sid).time += ev.timeOnPageSec || 0;
    sessions.get(sid).count++;
  });

  const sessionArray = Array.from(sessions.entries()).map(([id, data]) => ({
    id,
    time: data.time,
    count: data.count
  }));

  totalTime = sessionArray.reduce((sum, s) => sum + s.time, 0);

  return {
    pages,
    countries,
    sessions: sessionArray,
    totalTime,
    pageviews,
    totalEvents: events.length
  };
}
// Render page views with progress bars
function renderPageViews(pages) {
  const container = document.getElementById('pageViewsContainer');
  
  // Calculate totals
  const allPagesData = allPages.map(page => ({
    name: page,
    value: pages[page] || 0
  }));
  
  const total = allPagesData.reduce((sum, page) => sum + page.value, 0) || 1;
  
  if (total === 1 && allPagesData.every(p => p.value === 0)) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-chart-bar"></i>
        <div>No page view data available</div>
      </div>
    `;
    return;
  }

  container.innerHTML = ''; // <-- clear container before appending

  allPagesData
    .sort((a, b) => b.value - a.value)
    .forEach((page, i) => {
      const percent = Math.round((page.value / total) * 100);

      const item = document.createElement('div');
      item.className = 'page-view-item';
      item.innerHTML = `
        <div class="page-label">${page.name}</div>
        <div class="page-value">${page.value}</div>
        <div class="progress-container">
          <div class="progress-bar" 
               style="width: ${percent}%; background: ${colors[i % colors.length]}; display:flex; align-items:center; justify-content:flex-end; padding:5px; color:white; font-size:10px; font-weight:600;">
            ${percent}%
          </div>
        </div>
      `;
      container.appendChild(item);
    });
}


// Render country bars
function renderCountryBars(countries) {
  const container = document.getElementById('countryContainer');
  
  const countryEntries = Object.entries(countries);
  if (countryEntries.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-globe"></i>
        <div>No country data available</div>
      </div>
    `;
    return;
  }
  
  const total = countryEntries.reduce((sum, [_, count]) => sum + count, 0) || 1;
  
  container.innerHTML = '';
  
  countryEntries
    .sort((a, b) => b[1] - a[1])
    .forEach(([country, count], i) => {
      const percent = Math.round((count / total) * 100);
      
      const item = document.createElement('div');
      item.className = 'country-item';
      item.innerHTML = `
        <div class="country-flag" style="background: ${colors[i % colors.length]}">
          <div style="text-align: center; line-height: 20px; font-size: 14px;">
            ${countryFlags[country] || 'üè≥Ô∏è'}
          </div>
        </div>
        <div class="country-name">${country}</div>
        <div class="page-value">${count}</div>
        <div class="progress-container">
          <div class="progress-bar" style="width: ${percent}%; background: ${colors[i % colors.length]};"></div>
        </div>
      `;
      container.appendChild(item);
    });
}

// Render table
function renderTable(events) {
  const tbody = document.querySelector('#eventsTable tbody');
  
  if (!events || events.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="5" class="empty-state">
          <i class="fas fa-inbox"></i>
          <div>No events recorded yet</div>
        </td>
      </tr>
    `;
    return;
  }
  
  tbody.innerHTML = '';
  
  events
    .slice()
    .reverse()
    .slice(0, 15)
    .forEach(ev => {
      const tr = document.createElement('tr');
      const sessionShort = ev.sessionId ? ev.sessionId.substring(0, 8) + '...' : 'N/A';
      const typeClass = ev.type === 'pageview' ? 'pageview' : 'other';
      
      tr.innerHTML = `
        <td><span class="session-id">${sessionShort}</span></td>
        <td><span class="event-type ${typeClass}">${ev.type || 'unknown'}</span></td>
        <td>${ev.pagePath || 'Home'}</td>
        <td>${countryFlags[ev.country] || 'üè≥Ô∏è'} ${ev.country || 'Unknown'}</td>
        <td>${ev.timeOnPageSec || 0}s</td>
      `;
      tbody.appendChild(tr);
    });
}

// Refresh dashboard
async function refresh() {
  const lastUpdated = document.getElementById('lastUpdated');
  
  const events = await loadEvents();
  const summarized = summarize(events);
  
  // Update stats
  document.getElementById('totalEvents').textContent = summarized.totalEvents.toLocaleString();
  document.getElementById('uniqueSessions').textContent = summarized.sessions.length.toLocaleString();
  document.getElementById('avgTime').textContent = summarized.sessions.length > 0 
    ? Math.round(summarized.totalTime / summarized.sessions.length)
    : 0;
  document.getElementById('pageviews').textContent = summarized.pageviews.toLocaleString();
  
  // Render visualizations
  renderPageViews(summarized.pages);
  renderCountryBars(summarized.countries);
  renderTable(events);
  
  // Update timestamp
  const now = new Date();
  const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  lastUpdated.innerHTML = `<i class="fas fa-check-circle" style="color: #4cc9f0;"></i> Updated: ${timeStr}`;
}

// Add mock data button for testing (remove this in production)
function addMockDataButton() {
  const controls = document.querySelector('.controls');
  const mockBtn = document.createElement('button');
  mockBtn.className = 'btn';
  mockBtn.style.background = 'var(--warning)';
  mockBtn.innerHTML = '<i class="fas fa-magic"></i> Load Mock Data';
  mockBtn.onclick = loadMockData;
  controls.appendChild(mockBtn);
}

function loadMockData() {
  // Generate mock data
  const mockEvents = [];
  const countries = ['US', 'UK', 'CA', 'AU', 'DE', 'FR', 'JP', 'IN', 'BR'];
  const pages = allPages;
  
  for (let i = 0; i < 50; i++) {
    const sessionId = 'session_' + Math.floor(Math.random() * 1000);
    const eventCount = Math.floor(Math.random() * 5) + 1;
    
    for (let j = 0; j < eventCount; j++) {
      mockEvents.push({
        sessionId,
        type: Math.random() > 0.3 ? 'pageview' : 'click',
        pagePath: pages[Math.floor(Math.random() * pages.length)],
        country: countries[Math.floor(Math.random() * countries.length)],
        timeOnPageSec: Math.floor(Math.random() * 120),
        timestamp: new Date(Date.now() - Math.random() * 86400000).toISOString()
      });
    }
  }
  
  // Simulate loading the mock data
  const summarized = summarize(mockEvents);
  
  document.getElementById('totalEvents').textContent = mockEvents.length.toLocaleString();
  document.getElementById('uniqueSessions').textContent = summarized.sessions.length.toLocaleString();
  document.getElementById('avgTime').textContent = summarized.sessions.length > 0 
    ? Math.round(summarized.totalTime / summarized.sessions.length)
    : 0;
  document.getElementById('pageviews').textContent = summarized.pageviews.toLocaleString();
  
  renderPageViews(summarized.pages);
  renderCountryBars(summarized.countries);
  renderTable(mockEvents);
  
  document.getElementById('lastUpdated').innerHTML = '<i class="fas fa-check-circle" style="color: #4cc9f0;"></i> Updated: Mock Data Loaded';
  
  hideError();
}

// Initialize
document.getElementById('reloadBtn').addEventListener('click', refresh);
document.getElementById('exportBtn').addEventListener('click', () => {
  alert('Export would download a CSV file of all events');
});

// Add mock data button for testing
addMockDataButton();

// Initial load
refresh();

// Auto-refresh every 30 seconds
setInterval(refresh, 30000);
</script>

</body>
</html>



